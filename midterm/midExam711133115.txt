/*
【開課科系】臺北大學統計系(所)
【授課老師】陳祥輝
【Email】HsiangHui.Chen@gmail.com

112學年度第一學期 資料庫應用與商業智慧分析 課程 期中考試 老師：陳祥輝

學生學號：711133115
學生姓名：郭翊萱
電腦名稱：

注意事項：
1.請先將此檔案更改名稱為 : midExam+學號：，例如：midExam12345678.sql
2.切勿複製上課程式進行修改，一旦發現視同作弊論，會倒扣該題分數
3.每一題只能有一個答案，切勿將過程留在考題上，否則只會以第一個來評分
4.以下請用CH07範例資料庫，除非有特別指定
5.輸出屬性名稱前若是有 * 代表是 別名 或 衍生 屬性
6.請盡量達成使命, 請依循步驟讓你(妳)的語法是可以執行的。
7.不可執行的程式以0分計，可執行的程式才有可能部份會全部的分數，
  若是多個資料表必須完成join後才有部份分數。
8.給分標準，會因為每一題的重點不同，會有所差異
9.難易度僅供參考，會因個人而異
10.手機請收起來，不得置放於桌面上。
11.不可以使用ChatGPT
12.全部使用電腦教室電腦，除非有特殊需求，必須事先報備。
*/

use ch07範例資料庫;

/*01【難易度 : ★☆☆☆☆】10%
請查詢 除了 類別名稱為 茶類, 蘇打類, 果汁, 酒類 四類以外的其他產品庫存狀況
[輸出](類別名稱, 產品編號, 產品名稱, 建議單價, 平均成本, 庫存量, *庫存成本)
[排序]先以類別編號 遞增排序, 相同類別編號再以 產品編號 遞增排序
[說明]
庫存成本 : 平均成本 * 庫存量
*/
--【Solution】
select 類別名稱, 產品編號, 產品名稱, 建議單價, 平均成本, 庫存量
     , 平均成本*庫存量 as 庫存成本
from 產品資料 as p, 產品類別 as pd
where p.類別編號 = pd.類別編號
   and pd.類別名稱 not in ('茶類', '蘇打類', '果汁', '酒類')
order by p.類別編號 asc, p.產品編號 asc
go


/*02【難易度 : ★☆☆☆☆】10%
資料庫常常講 garbage in, garbage out
請幫忙查詢哪些員工迷迷糊糊，只輸入訂單資料，卻沒有訂單明細資料
[輸出](員工編號, *員工姓名, 訂單編號, 訂貨日期, *訂單季別)
[排序]員工編號 遞增排序, 相同員工編號再依據 訂單編號 遞減排序
[說明]
訂單季別 : 依據訂貨日期的季別，輸出格式應該為第一季 or 第二季 or 第三季 or 第四季
*/
--【Solution】
select e.員工編號, e.姓名 as 員工姓名, o.訂單編號, o.訂貨日期
     , '第' + cast(substring('一二三四', datepart(quarter, o.訂貨日期), 1) as varchar)+ '季' as 訂單季別
from 員工 as e, 訂單 as o
   left outer join 訂單明細 as od on od.訂單編號 = o.訂單編號
where e.員工編號 = o.員工編號
  and (o.訂單編號 is not null and od.訂單編號 is null)
order by e.員工編號 asc, o.訂單編號 desc
go


/*03【難易度 : ★★☆☆☆】10%
由於本公司近年來營運不好，必須進行人事調整
請產生一份報表資料，日期計算至 2023-08-01
在本公司的 足歲 滿55歲(含)以上，且 足年資 滿30年(含)以上
，且2006年沒有承接任何訂單的資料
[輸出](員工編號, 姓名, 出生日期, *虛歲, *足歲, 任用日期, *虛年資, *足年資)
[排序]依據年資遞減排序, 員工編號遞增排序
[說明]
虛歲 : 直接2023-08-01的年扣除 出生日期 的年，即可
足歲 : 就是 出生日期 精算 至2023-08-01，過了該日期才算足1歲
虛年資 : 直接2023-08-01的年扣除 任用日期 的年，即可
足年資 : 就是 任用日期 精算 至2023-08-01，過了該日期才算足1年
*/
--【Solution】

select e.員工編號, 姓名, 出生日期
     , datediff(year, e.出生日期, '2023/08/01') as 虛歲
     , datediff(year, e.出生日期, '2023/08/01')
	 - iif(month('2023/08/01') > month(e.出生日期)
     or month('2023/08/01') = month(e.出生日期) and day('2023/08/01') > month(e.出生日期), 0, 1) as 足歲
	 , 任用日期
	 , datediff(year, e.任用日期, '2023/08/01') as 虛年資
	 , datediff(year, e.任用日期, '2023/08/01')
	 - iif(month('2023/08/01') > month(e.任用日期)
     or month('2023/08/01') = month(e.任用日期) and day('2023/08/01') > month(e.任用日期), 0, 1) as 足年資
from 員工 as e, 訂單 as o
where e.員工編號 = o.員工編號
  and year(o.訂貨日期) not in (2006)
  and (datediff(year, e.出生日期, '2023/08/01')
	 - iif(month('2023/08/01') > month(e.出生日期)
     or month('2023/08/01') = month(e.出生日期) and day('2023/08/01') > month(e.出生日期), 0, 1)) >= 55
  and (datediff(year, e.任用日期, '2023/08/01')
	 - iif(month('2023/08/01') > month(e.任用日期)
     or month('2023/08/01') = month(e.任用日期) and day('2023/08/01') > month(e.任用日期), 0, 1)) >= 30
order by 足年資 desc, e.員工編號 asc
go


/*04【難易度 : ☆☆☆☆☆】10%
不知道公司有沒有客戶，同時也是供應商，請查詢看看
[輸出](客戶編號, *客戶名稱, 供應商編號, 供應商名稱)
[排序]客戶編號 遞減排序
[說明]
找出客戶的 公司名稱 與 供應商名稱 相同的資料
*/
--【Solution】
select c.客戶編號, c.公司名稱 as 客戶名稱, ca.供應商編號, ca.供應商名稱
from  客戶 as c, 訂單 as o, 訂單明細 as od, 產品資料 as p, 供應商 as ca
where c.客戶編號 = o.客戶編號
  and o.訂單編號 = od.訂單編號
  and od.產品編號 = p.產品編號
  and p.供應商編號 = ca.供應商編號
  and c.公司名稱 = ca.供應商名稱
order by c.客戶編號 desc
go
--結果:沒有同時是客戶也是供應商的公司


/*05【難易度 : ★★★☆☆】10%
請列出2005年曾經與本公司往來的客戶資料(就是曾經有過訂單資料)，
並且位於 台北、台中、高雄、宜蘭 客戶名冊
[輸出](*序號, *縣市, 客戶編號, 公司名稱, 聯絡人, 電話)
[排序]依據 縣市 遞增排序，縣市相同再依據 序號 排序
[說明]
縣市 : 是指地址的前三個字
序號 : 依據客戶編號遞增排序，並且必須依據不同 縣市 各別編列。使用 row_number()
[注意]
1.不要重複資料
2.不一定所有縣市都會有資料
*/
--【Solution】
select c.客戶編號, 公司名稱, 聯絡人, 電話
     , left(c.地址, 3) as 縣市
	 , row_number() over (partition by left(c.地址, 3) order by c.客戶編號 asc) as 序號
from 客戶 as c
where c.客戶編號 in (select distinct 客戶編號
                        from 訂單 as o
                        where o.訂單編號 is not null
                        and year(o.訂貨日期) = 2005)
and left(c.地址, 2) in ('台北', '台中', '高雄', '宜蘭')
order by 縣市 asc, 序號 asc
go


/*06【難易度 : ★☆☆☆☆】10%
請查詢訂單中已經出貨(出貨日期有資料)，卻還沒到貨的異常訂單(實際到貨日期沒有資料)
[輸出](員工編號, *員工姓名, 訂單編號, 預計到貨日期, 
       出貨日期, 實際到貨日期, 產品名稱, *延遲天數)
[排序]依據員工編號遞增排序，訂單編號遞增排序
[說明]
延遲天數 : 預計到貨日期 至 今天 的天數
出貨日期 : 將 出貨日期 的時間部分去除，只要留日期(date)的部分
*/
--【Solution】
select e.員工編號, 姓名 as 員工姓名, o.訂單編號, 預計到貨日期
       , cast(year(o.出貨日期) as varchar) + '-' + right('00' + cast(month(o.出貨日期) as varchar), 2) 
	   + '-' + right('00' + cast(day(o.出貨日期) as varchar), 2)  as 出貨日期
	   , 實際到貨日期, 產品名稱
	   , datediff(day, 預計到貨日期, getdate()) as 延遲天數
from 員工 as e, 訂單 as o, 訂單明細 as od, 產品資料 as p
where e.員工編號 = o.員工編號
  and o.訂單編號 = od.訂單編號
  and od.產品編號 = p.產品編號
  and (出貨日期 is not null and 實際到貨日期 is null)
order by e.員工編號 asc, o.訂單編號 asc
go



/*07【難易度 : ★☆☆☆☆】10%
請清查所有的客戶，列出 從未往來過(從未下過訂單)的客戶，
而且是位於 台北市 和 高雄市 的客戶資料，方便業務前往拜訪
[輸出](客戶編號, *客戶名稱, 聯絡人, 電話, 地址)
[排序]客戶編號 遞增排序
*/
--【Solution】

select c.客戶編號, c.公司名稱 as 客戶名稱, 聯絡人, 電話, 地址
from 客戶 as c
   left outer join 訂單 as o on c.客戶編號 = o.客戶編號
where left(c.地址, 3) in ('台北市', '高雄市')
   and 訂單編號 is null
order by c.客戶編號 asc
go


/*08【難易度 : ★☆☆☆☆】10%
由於公司資金不足，必須將產品轉換成現金，所以協助清查目前每一項產品的庫存狀態
只要列出庫存量大於等於安全存量的1.5倍之產品
[輸出](類別名稱, 產品編號, 產品名稱, 庫存量, 安全存量, *庫存成本, 庫存狀態)
[排序]
[說明]
1.庫存成本 : 平均成本*庫存量
2.庫存狀態
  庫存成本 大於等於 8000 顯示 高庫存成本
  庫存成本 小於 8000 且 大於等於 4000 顯示 中庫存成本
  庫存成本 小於 4000 顯示 低庫存成本
[注意]
*/
--【Solution】
select pd.類別名稱, p.產品編號, 產品名稱, 庫存量, 安全存量
     , 平均成本*庫存量 as 庫存成本
	 , case 
	     when (平均成本*庫存量 >= 8000) then '高庫存成本'
		 when (平均成本*庫存量 >= 4000 and 平均成本*庫存量 < 8000) then '中庫存成本'
		 when (平均成本*庫存量 < 8000) then '低庫存成本'
	   end as 庫存狀態
from 產品資料 as p, 產品類別 as pd
where p.類別編號 = pd.類別編號
   and 庫存量 >= 安全存量*1.5
go


/*09【難易度 : ★★☆☆☆】20%
請依據以下的步驟完成此題
1. 將 SleepInMammals.txt(哺乳類動物睡眠資料集) 匯入你(妳)自己的 CH07範例資料庫, 
   資料表名稱為 SleepInMammals (0%)
2. 請計算哺乳類動物的 體重(公斤) 與 腦重(克) 的比率，以及 最長壽命(年) 與 總睡眠(小時) 的比率，
   並依據 體重與腦重的比率 遞增排序，相同者並列出來
[輸出](動物種類, 體重(公斤), 腦重(克), *體重(公斤)/腦重(克)
     , 總睡眠(小時), 最長壽命(年), *最長壽命(年)/總睡眠(小時) )
[排序]體重(公斤)/腦重(克) 遞增排序, 必須精準至小數以下2位(固定長度 5, 2)之後再排序
[說明]
體重(公斤)/腦重(克) : 計算方式，體重(公斤)除以腦重(克)，精準至小數以下2位(固定長度 5, 2)
最長壽命(年)/總睡眠(小時) : 計算方式，最長壽命(年)/總睡眠(小時)，精準至小數以下2位(固定長度 5, 2)
[注意]
匯入SleepInMammals.txt時要特別注意編碼，無論如何匯入皆可，
例如，直接匯入，或是轉換編碼、轉成Excel、.....再匯入，沒有限制，只要能匯入
*/
--【Solution】
select 動物種類, [體重(公斤)], [腦重(克)], [總睡眠(小時)], [最長壽命(年)]
     , cast([體重(公斤)]/[腦重(克)]  as numeric(5, 2)) as [體重(公斤)/腦重(克)]
	 , cast([最長壽命(年)]/[總睡眠(小時)]  as numeric(5, 2)) as [最長壽命(年)/總睡眠(小時)]
from SleepInMammals as mm
order by cast([體重(公斤)]/[腦重(克)] as numeric(5, 2)) asc
go



